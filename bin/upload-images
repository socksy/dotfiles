#!/usr/bin/env bash
# should have `API_KEY=asdf1234` inside
set -x
source ~/bin/.immich-api-key
latest="$(curl -s -X POST "https://immich.lovell.io/api/search/metadata" -H "x-api-key: ${API_KEY}" -H "Content-Type: application/json" -d '{"make": "Panasonic", "order": "desc", "size": 1}' | jq -r '.assets.items[0].originalFileName')"
echo "Latest found upload: $latest"

DCIM_folder="${1-/Volumes/Untitled/DCIM}"
echo "cd'ing into $DCIM_folder"
cd "$DCIM_folder"

latest_folder_num="${latest:1:3}"
PANA_folders=()
for folder in *_PANA; do
  num="${folder:0:3}"
  if [[ $num -gt $latest_folder_num ]]; then
    PANA_folders+=("$folder")
  fi
done


immich_upload="immich-go upload from-folder --api-key=${API_KEY} --server=https://immich.lovell.io --skip-verify-ssl"
# special case the latest one since we only want to upload newer
# photos inside it
cd "${latest_folder_num}_PANA"
find . -name "*.JPG" -newer $latest -type f -print0 | xargs -0 $immich_upload
cd ..

cd "$DCIM_folder"
for folder in "${PANA_folders[@]}"; do
  cd "$folder" && $immich_upload *.JPG
  cd ..
done
